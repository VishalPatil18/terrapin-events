service: terrapin-events-appsync-resolvers

frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs20.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}
#  profile: tems-${self:provider.stage}

resources:
  Resources:
    # ==================== EVENT DATA SOURCES ====================
    CreateEventDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: CreateEventDataSource
        Description: Lambda data source for creating events
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-CreateEventLambdaArn

    UpdateEventDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: UpdateEventDataSource
        Description: Lambda data source for updating events
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-UpdateEventLambdaArn

    DeleteEventDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: DeleteEventDataSource
        Description: Lambda data source for deleting events
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-DeleteEventLambdaArn

    PublishEventDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: PublishEventDataSource
        Description: Lambda data source for publishing events
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-PublishEventLambdaArn

    # ==================== REGISTRATION DATA SOURCES ====================
    RegisterForEventDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: RegisterForEventDataSource
        Description: Lambda data source for event registration
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-RegisterForEventLambdaArn

    CancelRegistrationDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: CancelRegistrationDataSource
        Description: Lambda data source for cancelling registration
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-CancelRegistrationLambdaArn

    CheckInAttendeeDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: CheckInAttendeeDataSource
        Description: Lambda data source for checking in attendees
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-CheckInAttendeeLambdaArn

    ListMyRegistrationsDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: ListMyRegistrationsDataSource
        Description: Lambda data source for listing user registrations
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-ListMyRegistrationsLambdaArn

    # ==================== SEARCH DATA SOURCES (Week 7) ====================
    SearchEventsDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: SearchEventsDataSource
        Description: Lambda data source for advanced event search
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-SearchEventsLambdaArn

    GetCalendarEventsDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: GetCalendarEventsDataSource
        Description: Lambda data source for calendar event queries
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-GetCalendarEventsLambdaArn

    GetEventBySlugDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: GetEventBySlugDataSource
        Description: Lambda data source for slug-based event retrieval
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-GetEventBySlugLambdaArn

    # ==================== NOTIFICATION DATA SOURCES (Week 9) ====================
    ListNotificationsDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: ListNotificationsDataSource
        Description: Lambda data source for listing user notifications
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-ListNotificationsLambdaArn

    MarkAsReadDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: MarkAsReadDataSource
        Description: Lambda data source for marking notifications as read
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-MarkAsReadLambdaArn

    GetPreferencesDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: GetPreferencesDataSource
        Description: Lambda data source for getting notification preferences
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-GetPreferencesLambdaArn

    UpdatePreferencesDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: UpdatePreferencesDataSource
        Description: Lambda data source for updating notification preferences
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-UpdatePreferencesLambdaArn

    MarkAllAsReadDataSource:
      Type: AWS::AppSync::DataSource
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        Name: MarkAllAsReadDataSource
        Description: Lambda data source for marking all notifications as read
        Type: AWS_LAMBDA
        ServiceRoleArn: !GetAtt AppSyncLambdaRole.Arn
        LambdaConfig:
          LambdaFunctionArn:
            Fn::ImportValue: ${self:provider.stage}-MarkAllAsReadLambdaArn

    # ==================== IAM ROLES ====================
    AppSyncLambdaRole:
      Type: AWS::IAM::Role
      Properties:
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: appsync.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: AppSyncLambdaInvokePolicy
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - lambda:InvokeFunction
                  Resource:
                    # Event Lambdas
                    - Fn::ImportValue: ${self:provider.stage}-CreateEventLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-UpdateEventLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-DeleteEventLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-PublishEventLambdaArn
                    # Registration Lambdas
                    - Fn::ImportValue: ${self:provider.stage}-RegisterForEventLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-CancelRegistrationLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-CheckInAttendeeLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-ListMyRegistrationsLambdaArn
                    # Search Lambdas (Week 7)
                    - Fn::ImportValue: ${self:provider.stage}-SearchEventsLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-GetCalendarEventsLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-GetEventBySlugLambdaArn
                    # Additional Registration Lambdas
                    - Fn::ImportValue: ${self:provider.stage}-GetRegistrationLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-CheckUserRegistrationLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-GetEventCapacityLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-AcceptPromotionLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-DeclinePromotionLambdaArn
                    # Notification Lambdas (Week 9)
                    - Fn::ImportValue: ${self:provider.stage}-ListNotificationsLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-MarkAsReadLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-MarkAllAsReadLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-GetPreferencesLambdaArn
                    - Fn::ImportValue: ${self:provider.stage}-UpdatePreferencesLambdaArn

    # ==================== EVENT MUTATION RESOLVERS ====================
    CreateEventResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Mutation
        FieldName: createEvent
        DataSourceName: !GetAtt CreateEventDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    UpdateEventMutationResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Mutation
        FieldName: updateEvent
        DataSourceName: !GetAtt UpdateEventDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    DeleteEventMutationResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Mutation
        FieldName: deleteEvent
        DataSourceName: !GetAtt DeleteEventDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    PublishEventMutationResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Mutation
        FieldName: publishEvent
        DataSourceName: !GetAtt PublishEventDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    # ==================== REGISTRATION MUTATION RESOLVERS ====================
    RegisterForEventResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Mutation
        FieldName: registerForEvent
        DataSourceName: !GetAtt RegisterForEventDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    CancelRegistrationResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Mutation
        FieldName: cancelRegistration
        DataSourceName: !GetAtt CancelRegistrationDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    CheckInAttendeeResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Mutation
        FieldName: checkInAttendee
        DataSourceName: !GetAtt CheckInAttendeeDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    # ==================== REGISTRATION QUERY RESOLVERS ====================
    ListMyRegistrationsResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Query
        FieldName: listMyRegistrations
        DataSourceName: !GetAtt ListMyRegistrationsDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    # ==================== SEARCH QUERY RESOLVERS (Week 7) ====================
    AdvancedSearchEventsResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Query
        FieldName: advancedSearchEvents
        DataSourceName: !GetAtt SearchEventsDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    GetCalendarEventsResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Query
        FieldName: getCalendarEvents
        DataSourceName: !GetAtt GetCalendarEventsDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    GetEventBySlugResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Query
        FieldName: getEventBySlug
        DataSourceName: !GetAtt GetEventBySlugDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    # ==================== NOTIFICATION QUERY RESOLVERS (Week 9) ====================
    ListNotificationsResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Query
        FieldName: listNotifications
        DataSourceName: !GetAtt ListNotificationsDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    GetNotificationPreferencesResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Query
        FieldName: getNotificationPreferences
        DataSourceName: !GetAtt GetPreferencesDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    GetUnreadCountResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Query
        FieldName: getUnreadCount
        DataSourceName: !GetAtt ListNotificationsDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": {
              "arguments": {
                "unreadOnly": true,
                "limit": 1
              },
              "identity": $util.toJson($context.identity)
            }
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result.unreadCount)

    # ==================== NOTIFICATION MUTATION RESOLVERS (Week 9) ====================
    MarkNotificationAsReadResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Mutation
        FieldName: markNotificationAsRead
        DataSourceName: !GetAtt MarkAsReadDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    UpdateNotificationPreferencesResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Mutation
        FieldName: updateNotificationPreferences
        DataSourceName: !GetAtt UpdatePreferencesDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

    MarkAllNotificationsAsReadResolver:
      Type: AWS::AppSync::Resolver
      Properties:
        ApiId:
          Fn::ImportValue: ${self:provider.stage}-GraphQLApiId
        TypeName: Mutation
        FieldName: markAllNotificationsAsRead
        DataSourceName: !GetAtt MarkAllAsReadDataSource.Name
        RequestMappingTemplate: |
          {
            "version": "2018-05-29",
            "operation": "Invoke",
            "payload": $util.toJson($context)
          }
        ResponseMappingTemplate: |
          $util.toJson($context.result)

  Outputs:
    CreateEventDataSourceName:
      Description: Name of CreateEvent DataSource
      Value: !GetAtt CreateEventDataSource.Name
      Export:
        Name: ${self:provider.stage}-CreateEventDataSourceName

    RegisterForEventDataSourceName:
      Description: Name of RegisterForEvent DataSource
      Value: !GetAtt RegisterForEventDataSource.Name
      Export:
        Name: ${self:provider.stage}-RegisterForEventDataSourceName
